(function(t){function i(t,i,e){g(t.position,i.position,M);var o=t.shape.radius,n=i.shape.radius;(o+n)*(o+n)>S(M)&&(e.push(t),e.push(i))}function e(t,i,e){g(t.position,i.position,M),C.setFromRotation(q,i.angle),C.vectorMultiply(q,E,B),x(M,B)<=t.shape.radius&&(e.push(t),e.push(i))}function o(t,i,e){e.push(t),e.push(i)}function n(i,e,o,n){var a=n.length?n.pop():new t.ContactEquation(i,e);a.bi=i,a.bj=e,g(e.position,i.position,a.ni),y.normalize(a.ni,a.ni),b(a.ni,i.shape.radius,a.ri),b(a.ni,-e.shape.radius,a.rj),o.push(a)}function a(){}function r(i,e,o,n){var a=P,r=n.length?n.pop():new t.ContactEquation(e,i);r.bi=e,r.bj=i;var s=j,c=F;C.setFromRotation(a,e.angle),C.vectorMultiply(a,E,r.ni),y.scale(r.ni,-i.shape.radius,r.rj),y.subtract(i.position,e.position,s);var h=y.dot(r.ni,s);y.scale(r.ni,h,c),y.subtract(s,c,r.ri),o.push(r)}function s(){return performance.now?performance.now():performance.webkitNow?performance.webkitNow():((new Date).getTime(),void 0)}var t={},c=0,h=0,l=Float32Array,p=Math.cos,u=Math.abs,f=Math.sin,v=Math.sqrt,d=Math.floor;t.tVec2={},t.oVec2={},t.tVec2.create=function(t,i){c++;var e=new l(2);return e[0]=t||0,e[1]=i||0,e},t.oVec2.create=function(t,i){return{x:t||0,y:i||0}},t.tVec2.set=function(t,i,e){t[0]=i,t[1]=e},t.oVec2.set=function(t,i,e){t.x=i,t.y=e},t.tVec2.copy=function(t,i){i[0]=t[0],i[1]=t[1]},t.oVec2.copy=function(t,i){i.x=t.x,i.y=t.y},t.tVec2.add=function(t,i,e){e[0]=t[0]+i[0],e[1]=t[1]+i[1]},t.oVec2.add=function(t,i,e){e.x=t.x+i.x,e.y=t.y+i.y},t.tVec2.subtract=function(t,i,e){e[0]=t[0]-i[0],e[1]=t[1]-i[1]},t.oVec2.subtract=function(t,i,e){e.x=t.x-i.x,e.y=t.y-i.y},t.tVec2.scale=function(t,i,e){e[0]=t[0]*i,e[1]=t[1]*i},t.oVec2.scale=function(t,i,e){e.x=t.x*i,e.y=t.y*i},t.tVec2.normalize=function(i,e){var o=1/t.tVec2.norm(i);e[0]=i[0]*o,e[1]=i[1]*o},t.oVec2.normalize=function(i,e){var o=1/t.oVec2.norm(i);e.x=i.x*o,e.y=i.y*o},t.tVec2.norm=function(t){return v(t[0]*t[0]+t[1]*t[1])},t.oVec2.norm=function(t){return v(t.x*t.x+t.y*t.y)},t.tVec2.norm2=function(t){return t[0]*t[0]+t[1]*t[1]},t.oVec2.norm2=function(t){return t.x*t.x+t.y*t.y},t.tVec2.dot=function(t,i){return t[0]*i[0]+t[1]*i[1]},t.oVec2.dot=function(t,i){return t.x*i.x+t.y*i.y},t.tVec2.cross=function(t,i){return t[0]*i[1]-t[1]*i[0]},t.oVec2.cross=function(t,i){return t.x*i.y-t.y*i.x},t.tVec2.getX=function(t){return t[0]},t.tVec2.getY=function(t){return t[1]},t.oVec2.getX=function(t){return t.x},t.oVec2.getY=function(t){return t.y};var y=t.V=t.tVec2,m=y.add,b=y.scale,g=y.subtract,x=y.dot,V=y.cross,S=y.norm2,w=y.copy;t.tMat2={},t.oMat2={},t.tMat2.create=function(t,i,e,o){h++;var n=new l(4);return n[0]=t||0,n[1]=i||0,n[2]=e||0,n[3]=o||0,n},t.oMat2.create=function(t,i,e,o){return{e11:t||0,e12:i||0,e21:e||0,e22:o||0}},t.tMat2.vectorMultiply=function(t,i,e){e[0]=t[0]*i[0]+t[1]*i[1],e[1]=t[2]*i[0]+t[3]*i[1]},t.oMat2.vectorMultiply=function(t,i,e){e.x=t.e11*i.x+t.e12*i.y,e.y=t.e21*i.x+t.e22*i.y},t.tMat2.setIdentity=function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=1},t.oMat2.setIdentity=function(t){t.e11=1,t.e12=0,t.e21=0,t.e22=1},t.tMat2.setFromRotation=function(t,i){t[0]=p(i),t[1]=-f(i),t[2]=f(i),t[3]=p(i)},t.oMat2.setFromRotation=function(t,i){t.e11=p(i),t.e12=-f(i),t.e21=f(i),t.e22=p(i)};var C=t.M=t.tMat2;t.Shape=function(){},t.Particle=function(){t.Shape.apply(this)},t.Circle=function(i){t.Shape.apply(this),this.radius=i||1},t.Plane=function(){t.Shape.apply(this)},t.Spring=function(t,i,e){e=e||{},this.restLength=e.restLength||1,this.stiffness=e.stiffness||100,this.damping=e.damping||1,this.bodyA=t,this.bodyB=i},t.Body=function(t){t=t||{},this.shape=t.shape,this.mass=t.mass||0,this.invMass=this.mass>0?1/this.mass:0,this.inertia=t.inertia||this.mass,this.invInertia=this.invMass,this.position=t.position||y.create(),this.velocity=t.velocity||y.create(),this.vlambda=y.create(),this.wlambda=0,this.angle=t.angle||0,this.angularVelocity=t.angularVelocity||0,this.force=t.force||y.create(),this.angularForce=t.angularForce||0};var M=y.create(),q=C.create(),B=y.create(),E=y.create(0,1),P=C.create(),j=y.create(),F=y.create(),I=y.create(),G=y.create(),W=y.create(),k=y.create(),T=y.create(),A=y.create();t.Broadphase=function(){},t.Broadphase.prototype.getCollisionPairs=function(){throw Error("getCollisionPairs must be implemented in a subclass!")},t.NaiveBroadphase=function(){t.Broadphase.apply(this),this.getCollisionPairs=function(n){for(var a=n.collidingBodies,r=[],s=0,c=a.length;s!==c;s++){var h=a[s],l=h.shape;if(void 0!==l)for(var p=0;p!==s;p++){var u=a[p],f=u.shape;void 0!==f&&(l instanceof t.Circle?f instanceof t.Circle?i(h,u,r):f instanceof t.Particle?o(h,u,r):f instanceof t.Plane&&e(h,u,r):l instanceof t.Particle?f instanceof t.Circle&&o(u,h,r):l instanceof t.Plane&&f instanceof t.Circle&&e(u,h,r))}}return r}},t.NaiveBroadphase.prototype=new t.Broadphase,t.GridBroadphase=function(n,a,r,s,c,h){t.Broadphase.apply(this),c=c||10,h=h||10;var l=(a-n)/c,p=(s-r)/h,u=t.Plane,f=t.Circle,v=t.Particle;this.getCollisionPairs=function(m){for(var b=[],g=m.collidingBodies,x=x=g.length,V=[],S=c*h,w=0;S>w;w++)V.push([]);for(var C=c/(a-n),M=h/(s-r),w=0;w!==x;w++){var q=g[w],B=q.shape;if(void 0!==B)if(B instanceof f)for(var E=y.getX(q.position),P=y.getY(q.position),j=B.radius,F=d(C*(E-j-n)),I=d(M*(P-j-r)),G=d(C*(E+j-n)),W=d(M*(P+j-r)),k=F;G>=k;k++)for(var T=I;W>=T;T++){var A=k,N=T;A*(h-1)+N>=0&&S>A*(h-1)+N&&V[A*(h-1)+N].push(q)}else{if(!(B instanceof u))throw Error("Shape not supported in GridBroadphase!");if(0==q.angle)for(var P=y.getY(q.position),k=0;k!==S&&P>r+p*(k-1);k++)for(var T=0;c>T;T++){var A=T,N=d(M*(p*k-r));V[A*(h-1)+N].push(q)}else if(q.angle==.5*Math.PI)for(var E=y.getX(q.position),k=0;k!==S&&E>n+l*(k-1);k++)for(var T=0;h>T;T++){var N=T,A=d(C*(l*k-n));V[A*(h-1)+N].push(q)}else for(var k=0;k!==S;k++)V[k].push(q)}}for(var w=0;w!==S;w++)for(var z=V[w],k=0,R=z.length;k!==R;k++)for(var q=z[k],B=q.shape,T=0;T!==k;T++){var X=z[T],Y=X.shape;B instanceof t.Circle?Y instanceof f?i(q,X,b):Y instanceof v?o(q,X,b):Y instanceof u&&e(q,X,b):B instanceof v?Y instanceof f&&o(X,q,b):B instanceof u&&Y instanceof f&&e(X,q,b)}return b}},t.GridBroadphase.prototype=new t.Broadphase,t.World=function(i){i=i||{},this.springs=[],this.bodies=[],this.solver=i.solver||new t.GSSolver,this.contacts=[],this.oldContacts=[],this.collidingBodies=[],this.gravity=i.gravity||y.create(0,-9.78),this.doProfiling=!0,this.lastStepTime=0,this.broadphase=i.broadphase||new t.NaiveBroadphase},t.World.prototype.step=function(i){var e,o,l=this.doProfiling,p=this.springs.length,u=this.springs,f=this.bodies,v=(this.collidingBodies,this.gravity),d=this.solver,x=this.bodies.length,V=this.broadphase;l&&(e=s(),c=0,h=0);for(var S=0;S!==x;S++)w(v,f[S].force);for(var S=0;S!==p;S++){var C=u[S],M=C.stiffness,q=C.damping,B=C.restLength,E=C.bodyA,P=C.bodyB,j=I,F=G,N=W,z=k;g(E.position,P.position,j),g(E.velocity,P.velocity,N);var R=y.norm(j);y.normalize(j,F),b(F,M*(R-B)+q*y.dot(N,F),z),g(E.force,z,E.force),m(P.force,z,P.force)}for(var X=V.getCollisionPairs(this),Y=this.contacts.concat(this.oldContacts),L=this.contacts=[],O=t.Circle,D=t.Plane,H=t.Particle,S=0,J=X.length;S!==J;S+=2){var K=X[S],Q=X[S+1],U=K.shape,Z=Q.shape;U instanceof t.Circle?Z instanceof O?n(K,Q,L,Y):Z instanceof H?a(K,Q,L,Y):Z instanceof D&&r(K,Q,L,Y):U instanceof H?Z instanceof O&&a(Q,K,L,Y):U instanceof D&&Z instanceof O&&r(Q,K,L,Y)}this.oldContacts=Y;for(var S=0,$=L.length;S!==$;S++)d.addEquation(L[S]);d.solve(i,this),d.removeAllEquations();for(var _=T,ti=A,S=0;S!==x;S++){var ii=f[S];if(ii.mass>0){var ei=1/ii.mass,z=ii.force,oi=ii.position,ni=ii.velocity;ii.angularVelocity+=ii.angularForce*ii.invInertia*i,b(z,i*ei,_),m(_,ni,ni),b(ni,i,ti),m(oi,ti,oi)}}l&&(o=s(),this.lastStepTime=o-e,this.vecCreations=c,this.matCreations=h)},t.World.prototype.addSpring=function(t){this.springs.push(t)},t.World.prototype.removeSpring=function(t){var i=this.springs.indexOf(t);-1===i&&this.springs.splice(i,1)},t.World.prototype.addBody=function(t){this.bodies.push(t),this.collidingBodies.push(t)},t.World.prototype.removeBody=function(t){var i=this.bodies.indexOf(t);-1===i&&this.bodies.splice(i,1)},t.Solver=function(){this.equations=[]},t.Solver.prototype.solve=function(){return 0},t.Solver.prototype.addEquation=function(t){this.equations.push(t)},t.Solver.prototype.removeEquation=function(t){var i=this.equations.indexOf(t);-1!=i&&this.equations.splice(i,1)},t.Solver.prototype.removeAllEquations=function(){this.equations=[]},t.GSSolver=function(){t.Solver.call(this),this.iterations=10,this.h=1/60,this.k=1e7,this.d=6,this.a=0,this.b=0,this.eps=0,this.tolerance=0,this.setSpookParams(this.k,this.d),this.debug=!1,this.arrayStep=30,this.lambda=new l(this.arrayStep),this.Bs=new l(this.arrayStep),this.invCs=new l(this.arrayStep)},t.GSSolver.prototype=new t.Solver,t.GSSolver.prototype.setSpookParams=function(t,i){var e=this.h;this.k=t,this.d=i,this.a=4/(e*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(e*e*t*(1+4*i))},t.GSSolver.prototype.solve=function(t,i){var e=(this.d,this.k,0),o=this.iterations,n=this.tolerance*this.tolerance,a=this.a,r=this.b,s=this.eps,c=this.equations,h=c.length,p=i.bodies,f=i.bodies.length,v=t;h>this.lambda.length&&(this.lambda=new l(h+this.arrayStep),this.Bs=new l(h+this.arrayStep),this.invCs=new l(h+this.arrayStep));for(var d=this.invCs,b=this.Bs,g=this.lambda,x=0;x!==h;x++){var V=c[x];g[x]=0,b[x]=V.computeB(a,r,v),d[x]=1/V.computeC(s)}var S,V,w,C,M,q,B;if(0!==h){var x,E,P,j,F;for(x=0;x!==f;x++){var r=p[x],I=r.vlambda;y.set(I,0,0),r.wlambda=0}for(e=0;e!==o;e++){for(M=0,E=0;E!==h;E++)V=c[E],j=V.maxForce,P=V.minForce,S=b[E],w=d[E],B=g[E],q=V.computeGWlambda(s),C=w*(S-q-s*B),F=B+C,P>F?C=P-B:F>j&&(C=j-B),g[E]+=C,M+=u(C),V.addToWlambda(C);if(n>=M*M)break}for(x=0;x!==f;x++){var r=p[x],G=r.velocity;m(G,r.vlambda,G),r.angularVelocity+=r.wlambda}}return errorTot=M,e},t.Equation=function(t,i,e,o){this.id=-1,this.minForce=e===void 0?-1e6:e,this.maxForce=o===void 0?1e6:o,this.bi=t,this.bj=i},t.Equation.prototype.constructor=t.Equation,t.ContactEquation=function(i,e){t.Equation.call(this,i,e,0,1e6),this.penetration=0,this.ri=y.create(),this.penetrationVec=y.create(),this.rj=y.create(),this.ni=y.create(),this.rixn=y.create(),this.rjxn=y.create(),this.rixw=y.create(),this.rjxw=y.create(),this.relVel=y.create(),this.relForce=y.create()},t.ContactEquation.prototype=new t.Equation,t.ContactEquation.prototype.constructor=t.ContactEquation,t.ContactEquation.prototype.computeB=function(t,i,e){var o=this.bi,n=this.bj,a=this.ri,r=this.rj,s=o.position,c=n.position,h=o.velocity,l=o.angularVelocity,p=o.force,u=o.angularForce,f=n.velocity,v=n.angularVelocity,d=n.force,b=n.angularForce,S=(this.relVel,this.relForce,this.penetrationVec),w=o.invMass,C=n.invMass,M=o.invInertia,q=n.invInertia,B=this.ni,E=this.rixn=V(a,B),P=this.rjxn=V(r,B);y.set(S,0,0),m(c,r,S),g(S,s,S),g(S,a,S);var j=x(B,S),F=x(f,B)-x(h,B)+v*P-l*E,I=x(d,B)*C-x(p,B)*w+q*b*P-M*u*E,G=-j*t-F*i-e*I;return G},t.ContactEquation.prototype.computeC=function(t){var i=this.bi,e=this.bj,o=this.rixn,n=this.rjxn,a=i.invMass,r=e.invMass,s=a+r+t,c=i.invInertia,h=e.invInertia;return s+=c*o*o,s+=h*n*n};var N=y.create();t.ContactEquation.prototype.computeGWlambda=function(){var t=this.bi,i=this.bj,e=N,o=0;return y.subtract(i.vlambda,t.vlambda,e),o+=y.dot(e,this.ni),o-=t.wlambda*this.rixn,o+=i.wlambda*this.rjxn};var z=y.create();t.ContactEquation.prototype.addToWlambda=function(t){var i=this.bi,e=this.bj,o=this.rixn,n=this.rjxn,a=i.invMass,r=e.invMass,s=this.ni,c=z;b(s,a*t,c),g(i.vlambda,c,i.vlambda),b(s,r*t,c),m(e.vlambda,c,e.vlambda),i.wlambda-=i.invInertia*o*t,e.wlambda+=e.invInertia*n*t},"undefined"!=typeof module?module.exports=t:this.p2=t}).apply(this);